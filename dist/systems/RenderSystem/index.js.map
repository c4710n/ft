{"version":3,"sources":["../../../src/systems/RenderSystem/index.js"],"names":["Ticker","app","System","UPDATE_PRIORITY","Layer","PIXI","events","state","RenderSystem","type","width","height","transparent","antialias","LOW","container","size","getSize","options","renderer","Renderer","CanvasRenderer","autoDetectRenderer","view","style","zIndex","VIEW","position","stage","added","appendChild","remapInteraction","updateSize","resize","emit","centerX","centerY","center","render","interaction","plugins","normalizeToPointerData","processInteractive","autoPreventDefault","addEvents","bind","event","interactionDOMElement","target","call","allowInteraction","args","mapPositionToPoint","point","x","y","scale","systems","rotate","resolutionMultiplier","resolution","rect","getBoundingClientRect","top","left","setTargetElement","system","add","update","INTERACTION","window","navigator","msPointerEnabled","supportsPointerEvents","document","addEventListener","onPointerMove","onPointerDown","onPointerOut","onPointerOver","onPointerCancel","onPointerUp","supportsTouchEvents","eventsAdded"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,SAASA,MAAT,QAAuB,cAAvB;AACA,OAAOC,GAAP,MAAgB,WAAhB;AACA,OAAOC,MAAP,IAAiBC,eAAjB,QAAwC,WAAxC;AACA,SAASC,KAAT,EAAgBC,IAAhB,QAA4B,YAA5B;AACA,OAAOC,MAAP,MAAmB,cAAnB;AACA,OAAOC,KAAP,MAAkB,aAAlB;;IAEMC,Y;;;;;AACJ,0BAMQ;AAAA;;AAAA,mFAAJ,EAAI;AAAA,yBALNC,IAKM;AAAA,QALNA,IAKM,0BALC,MAKD;AAAA,0BAJNC,KAIM;AAAA,QAJNA,KAIM,2BAJE,GAIF;AAAA,2BAHNC,MAGM;AAAA,QAHNA,MAGM,4BAHG,IAGH;AAAA,gCAFNC,WAEM;AAAA,QAFNA,WAEM,iCAFQ,IAER;AAAA,8BADNC,SACM;AAAA,QADNA,SACM,+BADM,KACN;;AAAA;;AACN,8BAAM,QAAN,EAAgBV,eAAe,CAACW,GAAhC;AAEA,UAAKC,SAAL,GAAiBd,GAAG,CAACc,SAArB;AAEA,UAAKL,KAAL,GAAaA,KAAb;AACA,UAAKC,MAAL,GAAcA,MAAd;AACA,UAAKK,IAAL,GAAY,MAAKC,OAAL,EAAZ;AACAhB,IAAAA,GAAG,CAACe,IAAJ,GAAW,MAAKA,IAAhB;AAEA,QAAME,OAAO,GAAG;AAAER,MAAAA,KAAK,EAALA,KAAF;AAASC,MAAAA,MAAM,EAANA,MAAT;AAAiBC,MAAAA,WAAW,EAAXA,WAAjB;AAA8BC,MAAAA,SAAS,EAATA;AAA9B,KAAhB;;AAEA,QAAIJ,IAAI,KAAK,OAAb,EAAsB;AACpB,YAAKU,QAAL,GAAgB,IAAId,IAAI,CAACe,QAAT,CAAkBF,OAAlB,CAAhB;AACD,KAFD,MAEO,IAAIT,IAAI,KAAK,QAAb,EAAuB;AAC5B,YAAKU,QAAL,GAAgB,IAAId,IAAI,CAACgB,cAAT,CAAwBH,OAAxB,CAAhB;AACD,KAFM,MAEA;AACL,YAAKC,QAAL,GAAgBd,IAAI,CAACiB,kBAAL,CAAwBJ,OAAxB,CAAhB;AACD;;AACDjB,IAAAA,GAAG,CAACkB,QAAJ,GAAe,MAAKA,QAApB;AAEA,UAAKI,IAAL,GAAY,MAAKJ,QAAL,CAAcI,IAA1B;AACA,UAAKA,IAAL,CAAUC,KAAV,CAAgBC,MAAhB,GAAyBrB,KAAK,CAACsB,IAA/B;AACA,UAAKH,IAAL,CAAUC,KAAV,CAAgBG,QAAhB,GAA2B,UAA3B;AACA,UAAKJ,IAAL,CAAUC,KAAV,CAAgBd,KAAhB,GAAwB,MAAxB;AACA,UAAKa,IAAL,CAAUC,KAAV,CAAgBb,MAAhB,GAAyB,MAAzB;AACAV,IAAAA,GAAG,CAACsB,IAAJ,GAAW,MAAKA,IAAhB;AAEA,UAAKK,KAAL,GAAa3B,GAAG,CAAC2B,KAAjB;AACA,UAAKA,KAAL,CAAWC,KAAX,GAAmB,IAAnB,CA7BM,CA6BkB;;AAExB,UAAKd,SAAL,CAAee,WAAf,CAA2B,MAAKP,IAAhC;;AACA,UAAKQ,gBAAL;;AAhCM;AAiCP;AAED;AACF;AACA;AACA;AACA;AACA;;;;;WACE,gBAAOrB,KAAP,EAAcC,MAAd,EAAsB;AACpB,WAAKD,KAAL,GAAaA,KAAb;AACA,WAAKC,MAAL,GAAcA,MAAd;AAEA,WAAKqB,UAAL;AACA,WAAKb,QAAL,CAAcc,MAAd,CAAqBvB,KAArB,EAA4BC,MAA5B;AACAL,MAAAA,MAAM,CAAC2B,MAAP,CAAcC,IAAd;AACD;;;WAED,mBAAU;AACR,UAAQxB,KAAR,GAA0B,IAA1B,CAAQA,KAAR;AAAA,UAAeC,MAAf,GAA0B,IAA1B,CAAeA,MAAf;AAEA,aAAO;AACLD,QAAAA,KAAK,EAAEA,KADF;AAELC,QAAAA,MAAM,EAAEA,MAFH;AAGLwB,QAAAA,OAAO,EAAEzB,KAAK,GAAG,CAHZ;AAIL0B,QAAAA,OAAO,EAAEzB,MAAM,GAAG,CAJb;AAKL0B,QAAAA,MAAM,EAAE,CAAC3B,KAAK,GAAG,CAAT,EAAYC,MAAM,GAAG,CAArB;AALH,OAAP;AAOD;;;WAED,sBAAa;AACX,UAAQD,KAAR,GAA0B,IAA1B,CAAQA,KAAR;AAAA,UAAeC,MAAf,GAA0B,IAA1B,CAAeA,MAAf;AACA,WAAKK,IAAL,CAAUN,KAAV,GAAkBA,KAAlB;AACA,WAAKM,IAAL,CAAUL,MAAV,GAAmBA,MAAnB;AACA,WAAKK,IAAL,CAAUmB,OAAV,GAAoBzB,KAAK,GAAG,CAA5B;AACA,WAAKM,IAAL,CAAUoB,OAAV,GAAoBzB,MAAM,GAAG,CAA7B;AACA,WAAKK,IAAL,CAAUqB,MAAV,GAAmB,CAAC3B,KAAK,GAAG,CAAT,EAAYC,MAAM,GAAG,CAArB,CAAnB;AACD;;;WAED,kBAAS;AACP,UAAQiB,KAAR,GAA4B,IAA5B,CAAQA,KAAR;AAAA,UAAeT,QAAf,GAA4B,IAA5B,CAAeA,QAAf,CADO,CAGP;;AACAA,MAAAA,QAAQ,CAACmB,MAAT,CAAgBV,KAAhB;AACD;AAED;AACF;AACA;;;;WACE,4BAAmB;AACjB,UAAQb,SAAR,GAAgC,IAAhC,CAAQA,SAAR;AAAA,UAAmBI,QAAnB,GAAgC,IAAhC,CAAmBA,QAAnB;AACA,UAAQoB,WAAR,GAAwBpB,QAAQ,CAACqB,OAAjC,CAAQD,WAAR;AACA,UAAQE,sBAAR,GAAuDF,WAAvD,CAAQE,sBAAR;AAAA,UAAgCC,kBAAhC,GAAuDH,WAAvD,CAAgCG,kBAAhC;AAEAH,MAAAA,WAAW,CAACI,kBAAZ,GAAiC,KAAjC;AACAJ,MAAAA,WAAW,CAACK,SAAZ,GAAwBA,SAAS,CAACC,IAAV,CAAeN,WAAf,CAAxB;;AACAA,MAAAA,WAAW,CAACE,sBAAZ,GAAqC,UAAUK,KAAV,EAAiB;AACpD,aAAKC,qBAAL,GAA6BD,KAAK,CAACE,MAAnC;AACA,eAAOP,sBAAsB,CAACQ,IAAvB,CAA4B,IAA5B,EAAkCH,KAAlC,CAAP;AACD,OAHD;;AAIAP,MAAAA,WAAW,CAACG,kBAAZ,GAAiC,YAAmB;AAClD,YAAI,CAACnC,KAAK,CAAC2C,gBAAX,EAA6B;;AADqB,0CAANC,IAAM;AAANA,UAAAA,IAAM;AAAA;;AAElD,eAAOT,kBAAkB,CAACO,IAAnB,OAAAP,kBAAkB,GAAM,IAAN,SAAeS,IAAf,EAAzB;AACD,OAHD;;AAKAZ,MAAAA,WAAW,CAACa,kBAAZ,GAAiC,UAAUC,KAAV,EAAiBC,CAAjB,EAAoBC,CAApB,EAAuB;AACtD,YAAQC,KAAR,GAAkBvD,GAAG,CAACwD,OAAJ,CAAYD,KAAZ,CAAkB7B,QAApC,CAAQ6B,KAAR;AACA,YAAME,MAAM,GAAGzD,GAAG,CAACwD,OAAJ,CAAYD,KAAZ,CAAkBE,MAAjC,CAFsD,CAItD;;AACA,YAAMC,oBAAoB,GAAG,MAAM,KAAKC,UAAxC;AAEA,YAAMC,IAAI,GAAG9C,SAAS,CAAC+C,qBAAV,EAAb;;AAEA,YAAIJ,MAAJ,EAAY;AACVL,UAAAA,KAAK,CAACC,CAAN,GAAW,CAACC,CAAC,GAAGM,IAAI,CAACE,GAAV,IAAiBP,KAAlB,GAA2BG,oBAArC;AACAN,UAAAA,KAAK,CAACE,CAAN,GACG,CAACM,IAAI,CAACnD,KAAL,IAAc4C,CAAC,GAAGO,IAAI,CAACG,IAAvB,CAAD,IAAiCR,KAAlC,GAA2CG,oBAD7C;AAED,SAJD,MAIO;AACLN,UAAAA,KAAK,CAACC,CAAN,GAAW,CAACA,CAAC,GAAGO,IAAI,CAACG,IAAV,IAAkBR,KAAnB,GAA4BG,oBAAtC;AACAN,UAAAA,KAAK,CAACE,CAAN,GAAW,CAACA,CAAC,GAAGM,IAAI,CAACE,GAAV,IAAiBP,KAAlB,GAA2BG,oBAArC;AACD;AACF,OAjBD,CAhBiB,CAmCjB;;;AACApB,MAAAA,WAAW,CAAC0B,gBAAZ,CAA6BlD,SAA7B,EAAwCI,QAAQ,CAACyC,UAAjD;AACD;;;;EA7HwB1D,M;;AAgI3B,eAAeM,YAAf;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACA,SAASoC,SAAT,GAAqB;AACnB,MAAI,CAAC,KAAKG,qBAAV,EAAiC;AAC/B;AACD;;AAED/C,EAAAA,MAAM,CAACkE,MAAP,CAAcC,GAAd,CAAkB,KAAKC,MAAvB,EAA+B,IAA/B,EAAqCjE,eAAe,CAACkE,WAArD;;AAEA,MAAIC,MAAM,CAACC,SAAP,CAAiBC,gBAArB,EAAuC;AACrC,SAAKzB,qBAAL,CAA2BvB,KAA3B,CAAiC,qBAAjC,IAA0D,MAA1D;AACA,SAAKuB,qBAAL,CAA2BvB,KAA3B,CAAiC,kBAAjC,IAAuD,MAAvD;AACD,GAHD,MAGO,IAAI,KAAKiD,qBAAT,EAAgC;AACrC,SAAK1B,qBAAL,CAA2BvB,KAA3B,CAAiC,cAAjC,IAAmD,MAAnD;AACD;AACD;AACF;AACA;AACA;;;AACE,MAAI,KAAKiD,qBAAT,EAAgC;AAC9BH,IAAAA,MAAM,CAACI,QAAP,CAAgBC,gBAAhB,CAAiC,aAAjC,EAAgD,KAAKC,aAArD,EAAoE,IAApE;AACA,SAAK7B,qBAAL,CAA2B4B,gBAA3B,CACE,aADF,EAEE,KAAKE,aAFP,EAGE,IAHF,EAF8B,CAO9B;AACA;AACA;;AACA,SAAK9B,qBAAL,CAA2B4B,gBAA3B,CACE,cADF,EAEE,KAAKG,YAFP,EAGE,IAHF;AAKA,SAAK/B,qBAAL,CAA2B4B,gBAA3B,CACE,aADF,EAEE,KAAKI,aAFP,EAGE,IAHF;AAKAT,IAAAA,MAAM,CAACK,gBAAP,CAAwB,eAAxB,EAAyC,KAAKK,eAA9C,EAA+D,IAA/D;AACAV,IAAAA,MAAM,CAACK,gBAAP,CAAwB,WAAxB,EAAqC,KAAKM,WAA1C,EAAuD,IAAvD;AACD;;AAED,MAAI,KAAKC,mBAAT,EAA8B;AAC5B;AACA;AACA;AACA,SAAKnC,qBAAL,CAA2B4B,gBAA3B,CACE,YADF,EAEE,KAAKE,aAFP,EAGE,IAHF;AAKA,SAAK9B,qBAAL,CAA2B4B,gBAA3B,CACE,aADF,EAEE,KAAKK,eAFP,EAGE,IAHF;AAKA,SAAKjC,qBAAL,CAA2B4B,gBAA3B,CACE,UADF,EAEE,KAAKM,WAFP,EAGE,IAHF;AAKA,SAAKlC,qBAAL,CAA2B4B,gBAA3B,CACE,WADF,EAEE,KAAKC,aAFP,EAGE,IAHF;AAKD,GAxBD,MAwBO;AACLN,IAAAA,MAAM,CAACI,QAAP,CAAgBC,gBAAhB,CAAiC,WAAjC,EAA8C,KAAKC,aAAnD,EAAkE,IAAlE;AACA,SAAK7B,qBAAL,CAA2B4B,gBAA3B,CACE,WADF,EAEE,KAAKE,aAFP,EAGE,IAHF;AAKA,SAAK9B,qBAAL,CAA2B4B,gBAA3B,CACE,UADF,EAEE,KAAKG,YAFP,EAGE,IAHF;AAKA,SAAK/B,qBAAL,CAA2B4B,gBAA3B,CACE,WADF,EAEE,KAAKI,aAFP,EAGE,IAHF;AAKAT,IAAAA,MAAM,CAACK,gBAAP,CAAwB,SAAxB,EAAmC,KAAKM,WAAxC,EAAqD,IAArD;AACD;;AAED,OAAKE,WAAL,GAAmB,IAAnB;AACD","sourcesContent":["import { Ticker } from '@pixi/ticker'\nimport app from '../../app'\nimport System, { UPDATE_PRIORITY } from '../System'\nimport { Layer, PIXI } from '../../core'\nimport events from '../../events'\nimport state from '../../state'\n\nclass RenderSystem extends System {\n  constructor({\n    type = 'auto',\n    width = 750,\n    height = 1500,\n    transparent = true,\n    antialias = false,\n  } = {}) {\n    super('render', UPDATE_PRIORITY.LOW)\n\n    this.container = app.container\n\n    this.width = width\n    this.height = height\n    this.size = this.getSize()\n    app.size = this.size\n\n    const options = { width, height, transparent, antialias }\n\n    if (type === 'webgl') {\n      this.renderer = new PIXI.Renderer(options)\n    } else if (type === 'canvas') {\n      this.renderer = new PIXI.CanvasRenderer(options)\n    } else {\n      this.renderer = PIXI.autoDetectRenderer(options)\n    }\n    app.renderer = this.renderer\n\n    this.view = this.renderer.view\n    this.view.style.zIndex = Layer.VIEW\n    this.view.style.position = 'absolute'\n    this.view.style.width = '100%'\n    this.view.style.height = '100%'\n    app.view = this.view\n\n    this.stage = app.stage\n    this.stage.added = true // in order to make patchDisplayObjectLifecycle work.\n\n    this.container.appendChild(this.view)\n    this.remapInteraction()\n  }\n\n  /**\n   * Resize stage.\n   *\n   * @param {number} width\n   * @param {number} height\n   */\n  resize(width, height) {\n    this.width = width\n    this.height = height\n\n    this.updateSize()\n    this.renderer.resize(width, height)\n    events.resize.emit()\n  }\n\n  getSize() {\n    const { width, height } = this\n\n    return {\n      width: width,\n      height: height,\n      centerX: width / 2,\n      centerY: height / 2,\n      center: [width / 2, height / 2],\n    }\n  }\n\n  updateSize() {\n    const { width, height } = this\n    this.size.width = width\n    this.size.height = height\n    this.size.centerX = width / 2\n    this.size.centerY = height / 2\n    this.size.center = [width / 2, height / 2]\n  }\n\n  update() {\n    const { stage, renderer } = this\n\n    // render stage\n    renderer.render(stage)\n  }\n\n  /**\n   * @access private\n   */\n  remapInteraction() {\n    const { container, renderer } = this\n    const { interaction } = renderer.plugins\n    const { normalizeToPointerData, processInteractive } = interaction\n\n    interaction.autoPreventDefault = false\n    interaction.addEvents = addEvents.bind(interaction)\n    interaction.normalizeToPointerData = function (event) {\n      this.interactionDOMElement = event.target\n      return normalizeToPointerData.call(this, event)\n    }\n    interaction.processInteractive = function (...args) {\n      if (!state.allowInteraction) return\n      return processInteractive.call(this, ...args)\n    }\n\n    interaction.mapPositionToPoint = function (point, x, y) {\n      const { scale } = app.systems.scale.position\n      const rotate = app.systems.scale.rotate\n\n      // the unit of x, y is CSS pixel\n      const resolutionMultiplier = 1.0 / this.resolution\n\n      const rect = container.getBoundingClientRect()\n\n      if (rotate) {\n        point.x = ((y - rect.top) / scale) * resolutionMultiplier\n        point.y =\n          ((rect.width - (x - rect.left)) / scale) * resolutionMultiplier\n      } else {\n        point.x = ((x - rect.left) / scale) * resolutionMultiplier\n        point.y = ((y - rect.top) / scale) * resolutionMultiplier\n      }\n    }\n\n    // reset instance of InteractionManager\n    interaction.setTargetElement(container, renderer.resolution)\n  }\n}\n\nexport default RenderSystem\n\n/**\n * OVERRIDES ORIGINAL PIXI CODE\n *\n * make sure touch events and mouse events aren't binded together.\n *\n * PIXI VERSION: 5.1.1\n * + https://github.com/pixijs/pixi.js/blob/40e1e4a12518ee067c6871dcdd930602346197de/packages/interaction/src/InteractionManager.js\n */\nfunction addEvents() {\n  if (!this.interactionDOMElement) {\n    return\n  }\n\n  Ticker.system.add(this.update, this, UPDATE_PRIORITY.INTERACTION)\n\n  if (window.navigator.msPointerEnabled) {\n    this.interactionDOMElement.style['-ms-content-zooming'] = 'none'\n    this.interactionDOMElement.style['-ms-touch-action'] = 'none'\n  } else if (this.supportsPointerEvents) {\n    this.interactionDOMElement.style['touch-action'] = 'none'\n  }\n  /**\n   * These events are added first, so that if pointer events are normalized, they are fired\n   * in the same order as non-normalized events. ie. pointer event 1st, mouse / touch 2nd\n   */\n  if (this.supportsPointerEvents) {\n    window.document.addEventListener('pointermove', this.onPointerMove, true)\n    this.interactionDOMElement.addEventListener(\n      'pointerdown',\n      this.onPointerDown,\n      true\n    )\n    // pointerout is fired in addition to pointerup (for touch events) and pointercancel\n    // we already handle those, so for the purposes of what we do in onPointerOut, we only\n    // care about the pointerleave event\n    this.interactionDOMElement.addEventListener(\n      'pointerleave',\n      this.onPointerOut,\n      true\n    )\n    this.interactionDOMElement.addEventListener(\n      'pointerover',\n      this.onPointerOver,\n      true\n    )\n    window.addEventListener('pointercancel', this.onPointerCancel, true)\n    window.addEventListener('pointerup', this.onPointerUp, true)\n  }\n\n  if (this.supportsTouchEvents) {\n    // always look directly for touch events so that we can provide original data\n    // In a future version we should change this to being just a fallback and rely solely on\n    // PointerEvents whenever available\n    this.interactionDOMElement.addEventListener(\n      'touchstart',\n      this.onPointerDown,\n      true\n    )\n    this.interactionDOMElement.addEventListener(\n      'touchcancel',\n      this.onPointerCancel,\n      true\n    )\n    this.interactionDOMElement.addEventListener(\n      'touchend',\n      this.onPointerUp,\n      true\n    )\n    this.interactionDOMElement.addEventListener(\n      'touchmove',\n      this.onPointerMove,\n      true\n    )\n  } else {\n    window.document.addEventListener('mousemove', this.onPointerMove, true)\n    this.interactionDOMElement.addEventListener(\n      'mousedown',\n      this.onPointerDown,\n      true\n    )\n    this.interactionDOMElement.addEventListener(\n      'mouseout',\n      this.onPointerOut,\n      true\n    )\n    this.interactionDOMElement.addEventListener(\n      'mouseover',\n      this.onPointerOver,\n      true\n    )\n    window.addEventListener('mouseup', this.onPointerUp, true)\n  }\n\n  this.eventsAdded = true\n}\n"],"file":"index.js"}